define(["jquery","qtype_omerocommon/moodle-forms-utils","qtype_omerocommon/answer-base","qtype_omerocommon/multilanguage-element","qtype_omerocommon/multilanguage-attoeditor","qtype_omerocommon/roi-shape-model","qtype_omerocommon/roi-shape-table"],function(a,b,c){function d(){if(!g){g=[];for(var a=document.forms[0].elements.question_language,b=a.options,c=0;c<b.length;c++)g.push(b[c].value)}return g}function e(b){a("#modal-frame-text").html(b),a("#myModal").modal("show")}var f=a("#id_question_language"),g=null;console.log("Initialized",this),M.qtypes=M.qtypes||{},M.qtypes.omerocommon=M.qtypes.omerocommon||{},M.qtypes.omerocommon.QuestionEditorBase=function(){var b=this;b._localized_string_names=["questiontext","generalfeedback","correctfeedback","partiallycorrectfeedback","incorrectfeedback"],a(document).ready(function(){M.qtypes.omerocommon.MoodleFormUtils.initDropdown()})},M.qtypes.omerocommon.QuestionEditorBase.getInstance=function(){return M.qtypes.omerocommon.QuestionEditorBase.instance};var h=M.qtypes.omerocommon.QuestionEditorBase.prototype;return h.initialize=function(b,c){var e=this;d(),e._answers_section_id=b,e._fraction_options=c,e._show_roishape_column_group=!1,a(document).ready(function(){e._build_answer_controls(),e._editor={};for(var a in e._localized_string_names){var b=e._localized_string_names[a],c=new M.qtypes.omerocommon.MultilanguageAttoEditor(b,b+"_locale_map",!0);c.init(f.val(),b+"_locale_map"),c.loadDataFromFormInputs(b+"_locale_map"),c.onLanguageChanged(f.val()),e._editor[b]=c}if(e._answers_counter_element=document.forms[0].elements.noanswers,e._answers_counter_element){var d=e._answers_counter_element.getAttribute("value");if(d){d=parseInt(d);for(var a=0;d>a;a++)e.addAnswer(!0,a)}}else{var d=document.createElement("input");d.setAttribute("type","hidden"),d.setAttribute("name","noanswers"),d.setAttribute("value","0"),document.forms[0].appendElement(d),e._answers_counter_element=d}var g=jQuery;e._image_locked_element=g("[name^=omeroimagelocked]"),e._image_locked="1"==e._image_locked_element.val(),g("#omero-image-view-lock").bootstrapToggle(e._image_locked?"on":"off"),g("#omero-image-view-lock").change(function(){e._image_locked_element.val(g(this).prop("checked")?1:0)}),e._visible_roi_list=[],e.initElementList("visiblerois",e._visible_roi_list),e._focusable_roi_list=[],e.initElementList("focusablerois",e._focusable_roi_list),g("html, body").animate({scrollTop:g("#"+document.forms[0].getAttribute("id")).offset().top-200},500)}),e._answers=[],e._answer_ids={},f.on("change",function(b){e.onLanguageChanged(a(b.target).val())});var g=[];document.addEventListener("frameLoaded",function(a){e.onViewerFrameLoaded(a.detail.frame_id,g,a.detail)},!0);var h=function(a){try{e.saveAll();var b=e.validate();if(b.length>0){var c="";for(var d in b)c+='<i class="glyphicon glyphicon-thumbs-down red"></i>  '+b[d]+"<br>";e._showDialogMessage(c)}return 0===b.length}catch(a){console.error(a),e._showDialogMessage(a.message)}};a("input[name=updatebutton]").on("click",h),a("input[name=submitbutton]").on("click",h)},h.validate=function(a){a=a||[],this._image_viewer_controller&&null!==this._image_viewer_controller._image_id&&void 0!==this._image_viewer_controller._image_id||a.push(M.util.get_string("validate_no_image","qtype_omerocommon")),this._answers.length<1&&a.push(M.util.get_string("validate_no_answers","qtype_omerocommon"));var b=this.hasSingleCorrectAnswer(),c=0,d=0,e=0;for(var f in this._answers){var g=this._answers[f].getDataToSubmit(),h=parseFloat(g.fraction);h>c&&(c=h),1==h&&(e+=1),h>0&&(d+=h)}return b?0==e?a.push(M.util.get_string("validate_at_least_one_100","qtype_omerocommon")):e>1&&a.push(M.util.get_string("validate_at_least_one_100","qtype_omerocommon")):1!=d&&a.push(M.util.get_string("validate_sum_of_grades","qtype_omerocommon")),a},h._showDialogMessage=function(a){e(a)},h.hasSingleCorrectAnswer=function(){return 1==a("[name=single]").val()},h.saveAll=function(){this.saveMultilanguageElements();for(var a in this._answers)this._answers[a].saveDataToFormInputs(a)},h._build_answer_controls=function(){var b=this;try{a("#add_answer_button li").click(function(c){var d=a(c.target).attr("value");if(console.log("Click on ADD Answer no.",d),window.last=c.target,d){d=parseInt(d);for(var e=1;d>=e;e++)b.addAnswer(1!==e)}else console.warn("The number of answer to add seems to be undefined!!!")})}catch(c){console.error("Error while creating the toolbar",c)}},h.getSelectedROIIds=function(){return this._roi_shape_table?this._roi_shape_table.getIdSelections():[]},h.getSupportedLanguages=function(){return g.slice()},h.getCurrentLanguage=function(){return f.val()},h.onLanguageChanged=function(a){for(var b in this._editor)this._editor[b].onLanguageChanged(a)},h.isLockedImage=function(){return this._image_locked},h.lockImage=function(){this._image_locked_element.val(!0),this._image_locked=!0},h.unlockImage=function(){this._image_locked_element.val(!1),this._image_locked=!1},h.onLockImageChanged=function(a){a?this.lockImage():this.unlockImage()},h.updateViewCenter=function(){},h.saveMultilanguageElements=function(){console.log("Saving multi language elements...");for(var a in this._editor){var b=this._editor[a],c=a+"_locale_map",d="id_"+c;console.log("Saving editor data...",d,c);var e=document.forms[0].elements[c];e?console.log("Found hidden field to save editor data...",d,name,c):(e='<input id="'+d+'" name="'+c+'" type="hidden" >',console.log("Creating the hidden field",d,name,c),M.qtypes.omerocommon.MoodleFormUtils.appendHiddenElement(document.forms[0],e),console.log("Created the hidden field",d,name,c)),b.saveDataToFormInputs(c)}},h.buildAnswer=function(a,b){console.error("You need to implement this method!!!")},h.addAnswer=function(b,c){var d=this,e=M.qtypes.omerocommon.MoodleFormUtils.generateGuid(),f=this.buildAnswer(e,this._fraction_options);if(f){this._answers.push(f),this._answer_ids[e]=f,f.show(),"undefined"!=typeof c&&f.loadDataFromFormInputs(c,!0),f.remove=function(){d.removeAnswer(this._answer_number)},this.updateAnswerCounter();var g=f.getEditorsMap();for(var h in g)this._editor[h]=g[h];for(var h in this._answers)this._answers[h].updateHeader(parseInt(h)+1)}return b||a("html, body").animate({scrollTop:a("#"+e).offset().top-125},1e3),this.onAddAnswer&&this.onAddAnswer(f),f},h.removeAnswer=function(b){if(console.log(this._answers),b in this._answer_ids){var c=this._answer_ids[b];if(c){c.hide(),this._answers.splice(b,1),delete this._answer_ids[b],this.updateAnswerCounter();var d=c.getEditorsMap();for(var e in d){var f=d[e];f.destroy(),delete this._editor[e]}var g=null;for(var e in this._answers)this._answers[e].updateHeader(parseInt(e)+1),g=this._answers[e]._answer_head;return null!==g&&a("html, body").animate({scrollTop:g.offset().top-125},1e3),this.onRemoveAnswer&&this.onRemoveAnswer(c),!0}}return!1},h.updateAnswerCounter=function(){this._answers_counter_element.setAttribute("value",this._answers.length)},h.onViewerFrameLoaded=function(a,b,c){var d=this,e=document.getElementById(a);if(!e)throw"Frame "+a+" not found!!!";return d._omero_viewer_frame=e,void 0==c?d._omero_viewer_frame.contentWindow.addEventListener("omeroViewerInitialized",function(c){d.onViewerFrameInitialized(d,a,c.detail,b),console.log("OmeroImageViewer init loaded!!!")},!0):d.onViewerFrameInitialized(d,a,c,b),console.log("Frame Object Registered!!!"),d._omero_viewer_frame},h.onViewerFrameInitialized=function(b,c,d,e){b.current_image_info=d,b._registerFrameWindowEventHandlers(b,c),b._image_viewer_controller.getModel().addEventListener(b),a("#"+c+"-toolbar").removeClass("hidden"),b._image_viewer_controller.onViewerInitialized(function(){b._initImagePropertiesControls(),b._image_viewer_controller.updateViewFromProperties(b._image_properties)})},h.onImageModelRoiLoaded=function(a){var b=M.qtypes.omerocommon.RoiShapeModel.toRoiShapeModel(a.detail,this._visible_roi_list,this._focusable_roi_list);console.log("Loaded ROI Shapes Models",b),this._roi_shape_table||(this._roi_shape_table=new M.qtypes.omerocommon.RoiShapeTableBase("roi-shape-inspector-table"),this._roi_shape_table.initTable(!1,this._show_roishape_column_group),this._roi_shape_table.addEventListener(this)),this._roi_shape_table.removeAll(),this._roi_shape_table.appendRoiShapeList(b),this._image_viewer_controller.showRoiShapes(this._visible_roi_list),console.log("Updated ROI table!!!")},h._registerFrameWindowEventHandlers=function(a,b){var c=document.getElementById(b);if(!c)throw EventException("Frame "+b+" not found!!!");a._omero_viewer_frame=c;var d=a._omero_viewer_frame.contentWindow;a._image_viewer_controller=d.omero_repository_image_viewer_controller;var d=c.contentWindow},h.initElementList=function(b,c){var d=a("[name="+b+"]").val();if(d&&"none"!=d){var e=d.split(",");for(var f in e)c[f]=parseInt(e[f])}document.forms[0].addEventListener("submit",function(){a("[name="+b+"]").val(c.join(","))}),console.log("Initialized list",c)},h.onRoiShapeVisibilityChanged=function(a){console.log(a),this.onRoiShapePropertyChanged(a,"visible",this._visible_roi_list)},h.onRoiShapeFocusabilityChanged=function(a){console.log(a),this.onRoiShapePropertyChanged(a,"focusable",this._focusable_roi_list)},h.onRoiShapePropertyChanged=function(a,b,c){if(a.shape[b])"visible"===b&&this._image_viewer_controller.showRoiShapes([a.shape.id]),-1===c.indexOf(a.shape.id)&&c.push(a.shape.id);else{"visible"===b&&this._image_viewer_controller.hideRoiShapes([a.shape.id]);var d=c.indexOf(a.shape.id);d>-1&&c.splice(d,1)}},h.onRoiShapeFocus=function(a){this._image_viewer_controller.setFocusOnRoiShape.call(this._image_viewer_controller,a.shape.id)},h._initImagePropertiesControls=function(){var b=this;if(b._image_properties_element=a("[name^=omeroimageproperties]"),b._image_properties=b._image_properties_element.val(),b._image_properties&&0!==b._image_properties.length)try{b._image_properties=JSON.parse(b._image_properties)}catch(c){console.error(c),b._image_properties={}}else b._image_properties={};a("#omero-image-viewer-properties").html(b.getFormattedImageProperties()),a("#omero-image-properties-update").click(function(){b.updateImageProperties()})},h.getImageProperties=function(){return this._image_properties},h.getFormattedImageProperties=function(){var a=this._image_properties,b="";return a.center&&(b+="center (x,y): "+a.center.x+", "+a.center.y,b+=", zoom: "+a.zoom_level,b+=", t: "+a.t,b+=", z: "+a.z),b},h.updateImageProperties=function(){this._image_properties=this._image_viewer_controller.getImageProperties(),this._image_properties_element.val(JSON.stringify(this._image_properties)),a("#omero-image-viewer-properties").html(this.getFormattedImageProperties())},M.qtypes.omerocommon.QuestionEditorBase});