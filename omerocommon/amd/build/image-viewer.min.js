define(["jquery"],function(a){function b(a,b){for(var c in a){var b=a[c];b&&b()}-1===a.indexOf(b)&&b()}M.qtypes=M.qtypes||{},M.qtypes.omerocommon=M.qtypes.omerocommon||{},M.qtypes.omerocommon.ImageViewer=function(b,c,d,e,f,g,h){if(this._image_server=d,this._image_viewer_container_id=e,this._image_viewer_annotations_canvas_id=f,this._image_id=b,this._image_properties=c,this._viewer_model_server=g,this._listeners=[],this._lock_navigation=!1,this._viewer_config={showNavigator:!0,showFullPageControl:!1,animationTime:.01},this._scalebar_config={xOffset:10,yOffset:10,barThickness:5,color:"#777777",fontColor:"#000000",backgroundColor:"rgba(255, 255, 255, 0.5)"},h)for(var i in h)this._viewer_config[i]=h[i];var j=a("#"+this._image_viewer_container_id);if(j&&(j=j.parent())){var k=a("#"+this._image_viewer_container_id+"-loading-dialog");this._waiting_dialog=k}};var c=M.qtypes.omerocommon.ImageViewer.prototype;return c.open=function(a,c){var d=this;d._viewer_controller=new ViewerController(d._image_viewer_container_id,d._image_server+"/static/ome_seadragon/img/openseadragon/",d._image_server+"/ome_seadragon/deepzoom/get/"+d._image_id+".dzi",d._viewer_config),d._viewer_controller.buildViewer(),d._model=new ImageModelManager(d._viewer_model_server,d._image_id),d._viewer_controller.viewer.addHandler("open",function(){d._viewer_controller.setMinDZILevel(8),d._annotations_controller=new AnnotationsController(d._image_viewer_annotations_canvas_id),window.annotation_canvas=d._annotations_controller,d._annotations_controller.buildAnnotationsCanvas(d._viewer_controller),d._viewer_controller.addAnnotationsController(d._annotations_controller,!0),d.updateViewFromProperties(d._image_properties),d._model.getImageDZI(function(a){console.log("Loading openseadragon viewer");var b=a.image_mpp?a.image_mpp:0;d._viewer_controller.enableScalebar(b,d._scalebar_config)}),a?d.loadROIs(c):(b(d._listeners,c),d._waiting_dialog.hide())})},c.loadROIs=function(a){var c=this;c._model.loadRoisInfo(function(d){c._current_roi_list=d;for(var e in d){var f=d[e].shapes;for(var g in f){var h=f[g].type,i={fill_color:f[g].fillColor,fill_alpha:f[g].fillAlpha,stroke_color:f[g].strokeColor,stroke_alpha:f[g].strokeAlpha,stroke_width:f[g].strokeWidth};switch(h){case"Rectangle":c._annotations_controller.drawRectangle(f[g].id,f[g].x,f[g].y,f[g].width,f[g].height,TransformMatrixHelper.fromOMETransform(f[g].transform),i,!1);break;case"Ellipse":c._annotations_controller.drawEllipse(f[g].id,f[g].cx,f[g].cy,f[g].rx,f[g].ry,TransformMatrixHelper.fromOMETransform(f[g].transform),i,!1);break;case"Line":c._annotations_controller.drawLine(f[g].id,f[g].x1,f[g].y1,f[g].x2,f[g].y2,TransformMatrixHelper.fromOMETransform(f[g].transform),i,!1);break;default:console.warn("Unable to handle shape type "+h)}}}c._annotations_controller.hideShapes(void 0,!1),b(c._listeners,a),c._waiting_dialog.hide()})},c.isNavigationLocked=function(){return 1==this._lock_navigation},c.setNavigationLock=function(a){this._lock_navigation=a,a?(this._annotations_controller.disableMouseEvents(),this._annotation_events_controller.activateTool(this._annotation_events_controller.DUMMY_TOOL,!1)):this._annotations_controller.disableMouseEvents()},c.configureMarkingTool=function(a,b){this._annotation_events_controller=new AnnotationsEventsController(this._annotations_controller),this._annotation_events_controller.initializeImageMarkingTool(a.markers_size,a,b)},c.enableAddMarkers=function(){this._annotations_controller.disableMouseEvents(),this._annotation_events_controller.activateTool(this._annotation_events_controller.IMAGE_MARKING_TOOL)},c.enableMoveMarkers=function(){this._annotation_events_controller.activateTool(this._annotation_events_controller.DUMMY_TOOL,!1),this._annotations_controller.enableEventsOnShapes(this.getMarkerIds())},c.disableMarkingTool=function(){this._lock_navigation||this._annotations_controller.disableMouseEvents()},c.removeMarker=function(a){this._annotations_controller.removeMarker(a)},c.removeMarkers=function(){for(var a=this.getMarkerIds(),b=a.length-1;b>=0;b--)this.removeMarker(a[b])},c.onViewerInitialized=function(a){this._listeners.push(a)},c.getModel=function(){return this._model},c.getMarkerIds=function(){return this._annotations_controller.markers_id},c.getMarkers=function(){return this._annotations_controller.getShapes(this._annotations_controller.markers_id)},c.toShapeJSON=function(a){return this._annotations_controller.getShapesJSON([a])[0]},c.getShape=function(a){return this._annotations_controller.getShape(a)},c.getShapes=function(a){var b=[],c=this._annotations_controller.markers_id;console.log("markers ids...",c);var d=this._annotations_controller.getShapes(a);for(var e in d){var f=d[e];-1===c.indexOf(f.id)&&b.push(f)}return b},c.drawMarker=function(a,b){"circle"===a.type?this._annotations_controller.drawCircle(a.shape_id,a.center_x,a.center_y,a.radius,void 0,b,!0):console.warn("Marker not supported yet",a)},c.getImageProperties=function(){var a=this._viewer_controller.getViewportDetails();return{id:this._image_id,center:{x:a.center_x,y:a.center_y},t:1,z:1,zoom_level:a.zoom_level}},c.getImageSize=function(){return this._viewer_controller.getImageDimensions()},c.updateViewFromProperties=function(a){var b=this;if(!a||!a.center)return console.warn("incomplete image properties"),!1;var c=b._viewer_controller.getViewportCoordinates(a.center.x,a.center.y);a.zoom_level?(b._viewer_controller.jumpTo(a.zoom_level,c.x,c.y),console.log("Setting zoom level: "+a.zoom_level)):b._viewer_controller.jumpToPoint(c.x,c.y),console.log("Jumping to "+c.x+" -- "+c.y)},c.buildDetailedImageRelativeUrl=function(){var a=null,b=this._viewer_controller.getViewportDetails();return b?"/omero-image-repository/"+this._image_id+"?id="+this._image_id+"&t=1&z=1&zm="+b.zoom_level+"&x="+b.center_x+"&y="+b.center_y:a},c.getRoiList=function(){return this._current_roi_list},c.showRoiShapes=function(a,b){if(this._annotations_controller.showShapes(a,!0),b)for(var c in a)this._annotations_controller.getShape(a[c]).disableEvents()},c.hideRoiShapes=function(a){this._annotations_controller.hideShapes(a,!0)},c.setFocusOnRoiShape=function(a,b){this._viewer_controller.jumpToShape(a,b||!1),this._annotations_controller.selectShape(a,!0,!0)},c._addVisibleRoiShapes=function(a){if(a.split||(a=""+[a]),void 0!=a&&a.length>0){var b=a.split(",");for(var c in b){var d=b[c];for(var e in this._current_roi_list){var f=this._current_roi_list[e];if(f.id==d){this._visible_roi_shape_list[f.id]=[f.shapes[0]];break}}}}console.log("Visible ROI list",this._visible_roi_shape_list)},c._removeVisibleRoiShapes=function(a){if(a.split){if(void 0!=a&&a.length>0){var b=a.split(",");for(var c in b){var d=b[c];console.log("ARRAY: ",this._visible_roi_shape_list);this._visible_roi_shape_list.indexOf(d);delete this._visible_roi_shape_list[d],console.log("Removed visible roi element: ",this._visible_roi_shape_list)}}}else delete this._visible_roi_shape_list[a];console.log("Visible ROI list",this._visible_roi_shape_list)},console.log("Initialized qtype_omerocommon/image-viewer"),M.qtypes.omerocommon.ImageViewer});