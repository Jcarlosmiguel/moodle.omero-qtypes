define(["jquery","qtype_omerocommon/moodle-forms-utils","qtype_omerocommon/multilanguage-element","qtype_omerocommon/multilanguage-attoeditor"],function(a,b,c){function d(a,b){console.log("notifying event...",b);for(var c in a._listeners){var d=a._listeners[c],e="on"+b.name.charAt(0).toUpperCase()+b.name.substr(1);d&&d[e]&&d[e](b)}}M.qtypes=M.qtypes||{},M.qtypes.omerocommon=M.qtypes.omerocommon||{},M.qtypes.omerocommon.AnswerBase=function(b,c,d){var e=this;e._inputs={},e._editors_map={},e._data={},e._fraction_options=d,e._answer_list_container=a("#"+b+" .fcontainer"),e._listeners=[],e._form_utils=new M.qtypes.omerocommon.MoodleFormUtils,e._answer_number=void 0===c?M.qtypes.omerocommon.MoodleFormUtils.generateGuid():c};var e=M.qtypes.omerocommon.AnswerBase.prototype;return e.getId=function(){return this._answer_number},e._answer_properties=["answer","fraction","feedback"],e._build=function(){var b=this;b._answer_container=a('<div class="fitem" id="'+b._answer_number+'"></div>'),b._answer_list_container.append(b._answer_container),b._form_utils.appendElement(b._answer_container,"Grade","<select ><option>1</option></select>"),b._form_utils.appendElement(b._answer_container,"Feedback","<textarea>xxx</textarea>")},e.show=function(){var a=this;a._answer_container?a._answer_list_container.append(a._answer_container):a._build()},e.hide=function(){var a=this;a._answer_container&&a._answer_container.remove()},e.addListener=function(a){this._listeners.push(a)},e.removeListener=function(a){var b=this._listeners.indexOf(a);-1!==b&&this._listeners.splice(b,1)},e._notifyListeners=function(a){d(this,a)},e.getDataToSubmit=function(){var a={};for(var b in this._data)a[b]=this._data[b];return a},e.getEditorsMap=function(){var a={};for(var b in this._editors_map)a[this._answer_number+"_"+b]=this._editors_map[b];return a},e.updateHeader=function(a){this._answer_head.html(M.util.get_string("answer_choiceno","qtype_omerocommon")+a)},e.loadDataFromFormInputs=function(b,c){console.log("Loading data from inputs...",this);var d=this,e={};for(var f in d._answer_properties){var g=this._answer_properties[f],h=d.findFormInputElement(g,b);if(e[g]=h.val(),c&&h.remove(),h=d._inputs[g]){var i=parseFloat(e[g]);i=1==i||0==i?i.toFixed(1):i,document.getElementById(a(h).attr("id")).value=i}}console.log("Loading multi language elements...");for(var j in d._editors_map){var k=d._editors_map[j],l=d._build_locale_map_name_of(j,b),m="id_"+l;console.log("Loading editor data...",m,l),k.loadDataFromFormInputs(l),k.onLanguageChanged("en")}this._data=e},e.saveDataToFormInputs=function(a){var b=document.forms[0];if(!b)return void console.warn("Form not found!!!");for(var c in this._answer_properties){var d=this._answer_properties[c],e=this._build_id_of(d,a),f=this._build_name_of(d,a),g=this._data[d],h=document.getElementById(e);h?h.setAttribute("value",g):(h='<input id="'+e+'" name="'+f+'" type="hidden" value="'+g+'">',M.qtypes.omerocommon.MoodleFormUtils.appendHiddenElement(this._answer_container,h))}console.log("Saving multi language elements...",this._answer_number);for(var d in this._editors_map){var i=this._editors_map[d],j=this._build_locale_map_name_of(d,a),e="id_"+j;console.log("Saving editor data...",e,j);var h=document.getElementById(e);h?console.log("Found hidden field to save editor data...",e,f,j):(h='<input id="'+e+'" name="'+j+'" type="hidden" >',console.log("Creating the hidden field",e,f,j),M.qtypes.omerocommon.MoodleFormUtils.appendHiddenElement(this._answer_container,h),console.log("Created the hidden field",e,f,j)),i.saveDataToFormInputs(j)}},e.findFormInputElement=function(b,c){return a("[name*="+b+"\\["+c+"\\]]")},e._build_name_of=function(a,b){return b="undefined"!=typeof b?b:this._answer_number,a+"["+b+"]"},e._build_locale_map_name_of=function(a,b){return b="undefined"!=typeof b?b:this._answer_number,a+"_locale_map["+b+"]"},e._build_id_of=function(a,b){return"id_"+this._build_name_of(a,b)},e._build_textarea_of=function(a,b,c){var d=(this._build_id_of(a),this._build_name_of(a));this._data[a];c="undefined"==typeof c?this._build_locale_map_name_of(a):c;var e='<textarea id="'+this._build_id_of(a)+'" name="'+this._build_name_of(a)+'" rows="2"></textarea>';this._form_utils.appendElement(this._answer_container,b,e,c);var f=new M.qtypes.omerocommon.MultilanguageAttoEditor(d,c,!1);f.init("en"),this._editors_map[a]=f,console.log("Editors map",this._editors_map)},e._init_textarea_editor=function(a){var b=this._build_name_of(a),c=new M.qtypes.omerocommon.MultilanguageAttoEditor(b,this._build_locale_map_name_of(a),!1);c.init("en"),this._editors_map[b]=c},e._build_select_of=function(b,c){var d=this._build_id_of(b),e=this._build_name_of(b),f=this._data[b];"undefined"!=typeof f&&(f=parseFloat(f));var g='<select id="'+d+'_select" name="'+e+'_select">';for(var h in this._fraction_options)g+='<option value="'+h+'" '+(f==h?'selected="selected"':"")+">"+this._fraction_options[h]+"</option>";g+="</select>";var i=a(g);this._form_utils.appendElement(this._answer_container,c,i,!1),this._inputs[b]=g;var j=this;i=document.getElementById(d+"_select"),i.onchange=function(a){console.log("Changed grade",a),j._data[b]=i.options[i.selectedIndex].value}},e._build_hidden_of=function(b,c){var d=this._build_id_of(b),e=this._build_name_of(b),f=a("[name*="+b+"\\["+this._answer_number+"\\]]");if(f.length>0)c=f.val(),f.remove();else{var g='<input id="'+d+'" name="'+e+'" type="hidden" >';this._form_utils.appendElement(this._answer_container,"",g,!1)}},M.qtypes.omerocommon.AnswerBase});