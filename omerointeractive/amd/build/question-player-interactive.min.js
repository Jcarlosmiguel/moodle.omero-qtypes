define(["qtype_omerocommon/question-player-base","qtype_omerocommon/image-viewer"],function(a,b){function c(a,b){return a[n.ADD]===b||n.ADD===b?"btn-success":a[n.EDIT]===b||n.EDIT===b?"btn-warning":a[n.CLEAR]===b||n.CLEAR===b?"btn-danger":"btn-default"}function d(a,b){return a.answer_input_name.replace(":","-")+"-"+b}function e(a,b,d){var e=a._config,f=l("#"+e[b]);d?(f.removeClass("disabled"),b===n.CLEAR&&(f.removeClass("btn-default"),f.addClass("btn-danger"))):(f.addClass("disabled"),f.removeClass(c(a._config,b)),f.addClass("btn-default")),console.log("Changing the "+b+" controller!!",l("#"+e[b]))}function f(a,b){if(b!=m){var d=l("#"+m);d.removeClass(c(a,m)),d.addClass("btn-default"),d.removeClass("active")}if(b){var e=l("#"+b),f=c(a,b);if(!e.hasClass("active"))return e.removeClass("btn-default"),e.addClass(f),m=b,!0;e.removeClass(f),e.addClass("btn-default")}return!1}function g(a){return a._image_viewer_controller.getMarkerIds().length==a._config.max_markers}function h(a){var b=a,c={},d=[],e=a._config;console.log(e);var f=b._image_viewer_controller.getShapes(b._config.available_shapes),g=b._image_viewer_controller.getMarkers();console.log("Shapes",f),console.log("Markers",g);for(var h in g){console.log("Index: "+h);var i=g[h],j=i.getCenter();console.log("Checking marker",i.id,j);var k="none";for(var m in e.shape_groups){console.log("Group: "+m);for(var n in e.shape_groups[m].shapes){console.log("Shape id: "+n);var o=b._image_viewer_controller.getShape(e.shape_groups[m].shapes[n]);if(console.log("Checking against ",o,d,o.id in d),!(o.id in d)&&o.contains(j.x,j.y)){console.log("Contained in shape "+o.id),k={shape_id:o.id,shape_group:m,fraction:e.shape_groups[m].shape_grade},d[o.id]=o;break}}if("none"!==k)break}c[h]=k}var p=M.qtypes.omerocommon.MoodleFormUtils.htmlentities(M.qtypes.omerointeractive.QuestionPlayerInteractive.serializeResponse(g,c,b._image_viewer_controller)),q=["<input ",'type="hidden" ','id="'+b._answer_input_name+'0" ','name="'+b._answer_input_name+'" ','value="'+p+'" ',">"].join("");b._response_form.append(l(q)),console.log("Correction result: ",c)}function i(a,b,c,e){var f=a,g=a._config,h=d(g,n.DEL)+"-"+b+"_container",i=b,j=b.split("_");j&&2===j.length&&(i=j[1]),i=M.util.get_string("marker","qtype_omerointeractive")+" "+i,e=e?'style="color: '+e+';"':"";var k=l('<div id="'+h+'"><i id="'+d(g,n.GOTO)+"-"+b+'_btn"  class="glyphicon glyphicon-map-marker" '+e+"></i> "+i+(c?' <i id="'+d(g,n.DEL)+"-"+b+'_btn"  class="red glyphicon glyphicon-remove"></i> ':"")+(c?' <small><i id="'+d(g,n.HIDE)+"-"+b+'_btn"  class="glyphicon glyphicon-eye-open" style="color: #555"></i></small> ':"")+" |</div>");f._remove_markers_container.append(k),l("#"+d(g,n.DEL)+"-"+b+"_btn").bind("click",{marker_id:b,btn_id:"del_"+b,marker_info_container:h},function(a){f._image_viewer_controller.removeMarker(a.data.marker_id)}),l("#"+d(g,n.HIDE)+"-"+b+"_btn").bind("click",{marker_id:b,btn_id:"del_"+b,marker_info_container:h},function(a){console.log("Event",a);var b=l(a.target);b.hasClass("glyphicon-eye-open")?(f._image_viewer_controller.hideRoiShapes([a.data.marker_id]),b.removeClass("glyphicon-eye-open"),b.addClass("glyphicon-eye-close"),b.css("color","#999")):(b.removeClass("glyphicon-eye-close"),b.addClass("glyphicon-eye-open"),b.css("color","#555"),f._image_viewer_controller.showRoiShapes([a.data.marker_id]))}),l("#"+d(g,n.GOTO)+"-"+b+"_btn").bind("click",{marker_id:b},function(a){f._image_viewer_controller.setFocusOnRoiShape(a.data.marker_id)})}function j(a){if(!a)return void console.warn("You have to provide the player object");var b=a,c=a._config;if(a._image_viewer_controller.showRoiShapes(c.visible_rois),a._image_viewer_controller.showRoiShapes(c.available_shapes),c.answers){for(var d in c.answers.markers){var e=c.answers.shapes[d],f=c.answers.markers[d],g=void 0;console.log("Check Marker: ",f,o),g="none"===e||e.fraction<=0?p.wrong:1==c.max_markers&&e.fraction<1?p.partially_correct:p.correct,g&&(o.fill_color=g,o.stroke_color=g),a._image_viewer_controller.drawMarker(f,o),i(a,f.shape_id,!c.correction_mode,o.stroke_color)}var h=" .roi-shape-info",j=l("#"+c.question_answer_container).parents("form");h="#"+(j&&j.attr("id")?j.attr("id"):c.question_answer_container)+h,l(h).each(function(){console.log("Updating properties of the ROI shape:",l(this).attr("roi-shape-id"));var b=l(this).attr("roi-shape-id"),c=a._image_viewer_controller.getShape(b);console.log("Check the current shape",c),c&&(l(this).css("color",c.toJSON().stroke_color),l(this).click(function(){a._image_viewer_controller.setFocusOnRoiShape(b)}))}),h=" .roi-shape-visibility",j=l("#"+c.question_answer_container).parents("form"),h="#"+(j&&j.attr("id")?j.attr("id"):c.question_answer_container)+h,l(h).each(function(a,c){var d=l(c);d.bind("click",{marker_id:d.attr("roi-shape-id"),btn_id:"hide_"+d.attr("roi-shape-id")},function(a){console.log("Event",a);var c=l(a.target);c.hasClass("glyphicon-eye-open")?(b._image_viewer_controller.hideRoiShapes([a.data.marker_id]),c.removeClass("glyphicon-eye-open"),c.addClass("glyphicon-eye-close"),c.css("color","#999")):(c.removeClass("glyphicon-eye-close"),c.addClass("glyphicon-eye-open"),c.css("color","#555"),b._image_viewer_controller.showRoiShapes([a.data.marker_id]))})}),l("#"+c.question_answer_container+" .question-summary").removeClass("hidden")}else console.log("No answer found!!!")}function k(a){var b=a,c=b._config;b._image_viewer_controller.open(!0,function(){console.log("Question Player initialized!!!",c);var d=b._image_viewer_controller.getImageSize(),f=(d.width+d.height)/2*.0025;o.markers_size=f,console.log(f),b._image_viewer_controller.configureMarkingTool(o,parseInt(c.max_markers)),a._image_viewer_controller.setNavigationLock(c.image_navigation_locked),c.correction_mode?(console.log("Answers: ",c.answers),j(b)):b._image_viewer_controller.showRoiShapes(c.visible_rois,!0),b.showFocusAreas(),e(b,n.ADD,!c.correction_mode),e(b,n.EDIT,!1),e(b,n.CLEAR,!1)})}var l=jQuery,m=null,n={ADD:"enable_add_makers_ctrl_id",EDIT:"enable_edit_markers_ctrl_id",DEL:"remove_marker_ctrl_id",CLEAR:"clear_marker_ctrl_id",GOTO:"goto_marker_ctrl_id",HIDE:"hide_marker_ctrl_id"},o={fill_color:"#ffffff",fill_alpha:.4,stroke_width:10},p={correct:"#5AB55A",wrong:"#C44540",partially_correct:"#F9A125"};console.log("Initialized",this),M.qtypes=M.qtypes||{},M.qtypes.omerointeractive=M.qtypes.omerointeractive||{},M.qtypes.omerocommon.QuestionPlayerBase=a,M.qtypes.omerointeractive.QuestionPlayerInteractive=function(){M.qtypes.omerocommon.QuestionPlayerBase.call(this)},M.qtypes.omerointeractive.QuestionPlayerInteractive.prototype=new M.qtypes.omerocommon.QuestionPlayerBase,M.qtypes.omerointeractive.QuestionPlayerInteractive.prototype.constructor=M.qtypes.omerointeractive.QuestionPlayerInteractive,M.qtypes.omerointeractive.QuestionPlayerInteractive.prototype.parent=M.qtypes.omerocommon.QuestionPlayerBase.prototype,M.qtypes.omerointeractive.QuestionPlayerInteractive.getInstance=function(){return M.qtypes.omerocommon.QuestionPlayerBase.instance||(M.qtypes.omerocommon.QuestionPlayerBase.instance=new M.qtypes.omerointeractive.QuestionPlayerInteractive),M.qtypes.omerocommon.QuestionPlayerBase.instance};var q=M.qtypes.omerointeractive.QuestionPlayerInteractive.prototype;q.initialize=function(a){var b=this;if(b.initialized)console.log("Already Initialized");else if(this.parent.initialize.call(this,a),b._answer_input_name=a.answer_input_name,console.log("Setted the answer prefix",b._answer_input_name),l("#"+a[n.ADD]).click(function(){f(a,a[n.ADD])?b._image_viewer_controller.enableAddMarkers():b._image_viewer_controller.disableMarkingTool()}),l("#"+a[n.EDIT]).click(function(){f(a,a[n.EDIT])?b._image_viewer_controller.enableMoveMarkers():b._image_viewer_controller.disableMarkingTool()}),l("#"+a[n.CLEAR]).click(function(){b._image_viewer_controller.removeMarkers(),b._image_viewer_controller.disableMarkingTool(),f(a)}),b._remove_markers_container=l("#"+a.marker_removers_container),l("#"+a.question_answer_container+" .restore-image-center-btn").click(function(){b._image_viewer_controller.updateViewFromProperties(a.image_properties)}),!a.correction_mode){var c=l("#"+a.enable_add_makers_ctrl_id).parents("form");c?(b._response_form=c,c.on("submit",function(){h(b)})):console.error("Unable to find the form"),l("#"+a.image_annotations_canvas_id).on("marker_created",function(c,d){console.log("A new marker with ID "+d+" was created",c),g(b)&&(console.log("Reached max number of markers: "+a.max_markers),e(b,n.ADD,!1),b._image_viewer_controller.disableMarkingTool()),e(b,n.EDIT,!0),e(b,n.CLEAR,!0),i(b,d,!a.correction_mode)}),l("#"+a.image_annotations_canvas_id).on("marker_deleted",function(c,f){console.log("Remove marker with ID '"+f+"'",c),g(b)||e(b,n.ADD,!0),0===b._image_viewer_controller.getMarkers().length&&(e(b,n.EDIT,!1),e(b,n.CLEAR,!1)),l("#"+d(a,n.DEL)+"-"+f+"_container").remove()})}b.initialized=!0,k(b)},q.checkAnswers=function(a){h(this)};var r=M.qtypes.omerointeractive.QuestionPlayerInteractive;return r.serializeResponse=function(a,b,c){var d={markers:l.map(a,function(a,b){var d=c.toShapeJSON(a.id);return d}),shapes:l.map(b,function(a,b){return a})};return console.log(d),JSON.stringify(d)},r.deserializeResponse=function(a){var a=JSON.parse(a);return a},r.start=function(a){var b=document.getElementById("viewer-config"),a=JSON.parse(b.value);console.log("QuestionPlayer interactive configuration",a);var c=new M.qtypes.omerointeractive.QuestionPlayerInteractive;c.initialize(a),console.log("Question interactive player initialized!!!")},r});