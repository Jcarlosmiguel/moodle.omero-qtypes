define(["jquery","qtype_omerocommon/moodle-forms-utils","qtype_omerocommon/answer-base","qtype_omerocommon/multilanguage-attoeditor"],function(a,b,c,d){var e=jQuery;console.log("Initialized",this),M.qtypes=M.qtypes||{},M.qtypes.omerointeractive=M.qtypes.omerointeractive||{},M.qtypes.omerointeractive.AnswerGroup=function(a,b,c){var d=this;M.qtypes.omerocommon.AnswerBase.call(this,a,b,c),d._roi_id_list=[],d._init_roi_list(),d._initContextMenu()},M.qtypes.omerointeractive.AnswerGroup.prototype=new M.qtypes.omerocommon.AnswerBase,M.qtypes.omerointeractive.AnswerGroup.prototype.constructor=M.qtypes.omerointeractive.AnswerGroup,M.qtypes.omerointeractive.AnswerGroup.prototype.parent=M.qtypes.omerocommon.AnswerBase.prototype;var f=M.qtypes.omerointeractive.AnswerGroup.prototype;return f._build=function(){var a=this,b=e('<div class="panel panel-default"></div>');a._answer_list_container.append(b);var c=e('<div class="panel-heading"><h4 class="panel-title"><span id="head-answer-'+this._answer_number+'">Answer '+(this._answer_number+1)+'</span><div style="display: inline-block; float: right; text-align: right;"><a href="javascript:void(0)" id="delete-answer-'+a._answer_number+'" ><i class="red glyphicon glyphicon-remove-sign" style="font-size: 2m;"></i></a></h4></div><div style="display: block; float: right; margin: 20px 30px;"></div>');b.append(c);var d=e('<div class="panel-body"></div>');b.append(d),a._answer_container=e('<div class="fitem" id="'+a._answer_number+'"></div>'),d.append(a._answer_container),a._build_list_of_rois("answer",M.util.get_string("answer_group_of_rois","qtype_omerointeractive")),a._build_select_of("fraction",M.util.get_string("answer_grade","qtype_omerocommon")),a._build_textarea_of("feedback",M.util.get_string("feedback","question")),a._answer_head=e("#head-answer-"+this._answer_number),e("#delete-answer-"+a._answer_number).on("click",function(){a.remove()}),a._answer_container=b},f.addROIsToGroup=function(a){var b=this,c=!1,d=this._roi_id_list;for(var e in a)-1===d.indexOf(a[e])&&(d.push(a[e]),c=!0);c&&(this.updateROIList(),this._notifyListeners({name:"AnswerROIsAdded",answer:b,roi_id_list:a}))},f.removeROIsFromGroup=function(a){var b=this,c=!1,d=this._roi_id_list;for(var e in a){var f=d.indexOf(a[e]);-1!==f&&(d.splice(f,1),c=!0)}c&&(this.updateROIList(),this._notifyListeners({name:"AnswerROIsRemoved",answer:b,roi_id_list:a}))},f.containsROIs=function(a){for(var b in a)if(-1!==this._roi_id_list.indexOf(a[b]))return!0;return!1},f.getROIsWithinGroup=function(){return this._roi_id_list},f._init_roi_list=function(){var a=this._data.answer;a&&a.length>0&&(this._roi_id_list=a.split(",").map(function(a){return parseInt(a)}))},f._build_list_of_rois=function(a,b){var c=this._build_id_of(a),d=this._build_name_of(a);this._init_roi_list();var f='<div id="'+c+'_roi_list" name="'+d+'_answer_roi_list"></div>',g=e("[name*="+a+"\\["+this._answer_number+"\\]]");0==g.length&&(f+='<input type="hidden" name="'+d+'" value="">');var h=e(f);this._form_utils.appendElement(this._answer_container,b,h,!1),this._roi_id_list&&this.updateROIList()},f.updateROIList=function(){var a=this._build_id_of("answer"),b=document.getElementById(a+"_roi_list"),c=[];for(var d in this._roi_id_list)c.push(['<span id="'+this._roi_id_list[d]+'-roi-shape-answer-option">','<i class="green glyphicon glyphicon-map-marker"></i> ',this._roi_id_list[d],"</span>"].join(""));b.innerHTML=c.join(", "),e("[name*=answer\\["+this._answer_number+"\\]]").val(this._roi_id_list.join(",")),this._data.answer=this._roi_id_list.join(","),this._initContextMenuOn()},f._initContextMenuOn=function(){var a=this;for(var b in this._roi_id_list){var c="#"+this._roi_id_list[b]+"-roi-shape-answer-option";e(c).contextMenu({menuSelector:"#roishape-answer-option-ctx-menu",menuSelected:function(b,c){if("roishape-answer-option-delete"===c.attr("id")){var d=b.prop("id").match(/(.+)-roi-shape-answer-option/),e=d[1];if(!e)return void console.warn("Unable to identify the ROI id!!!");a.removeROIsFromGroup([parseInt(e)])}}})}},f._initContextMenu=function(){!function(a,b){a.fn.contextMenu=function(c){function d(d,e,f){var g=a(b)[e](),h=a(b)[f](),i=a(c.menuSelector)[e](),j=d+h;return d+i>g&&d>i&&(j-=i),j}return this.each(function(){a(this).on("contextmenu",function(b){if(!b.ctrlKey){var e=a(c.menuSelector).data("invokedOn",a(b.target)).show().css({position:"absolute",left:d(b.clientX,"width","scrollLeft"),top:d(b.clientY,"height","scrollTop")}).off("click").on("click","a",function(b){e.hide();var d=e.data("invokedOn"),f=a(b.target);d="I"==d.prop("tagName")?d.parent():d,c.menuSelected.call(this,d,f)});return!1}}),a(document).click(function(){a(c.menuSelector).hide()})})}}(jQuery,window)},M.qtypes.omerointeractive.AnswerGroup});